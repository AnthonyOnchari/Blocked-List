<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocked List Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* COMPLETE CSS RESET - FIX SCROLLING */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-overflow-scrolling: touch;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden; /* CRITICAL: Prevent page scrolling */
      font-family: 'Outfit', sans-serif;
      position: fixed; /* CRITICAL: Fix the page */
    }
    
    /* Remove ALL possible scrolling from body */
    body {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-in { animation: slideIn 0.3s ease-out; }
    
    /* ================= MAIN APP ================= */
    /* MAIN WRAPPER - ABSOLUTELY NO SCROLLING */
    #app-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1;
    }
    
    /* APP CONTENT - ABSOLUTELY NO SCROLLING */
    .app-content {
      width: 100%;
      max-width: 500px;
      height: 100%;
      max-height: 800px;
      display: flex;
      flex-direction: column;
    }
    
    /* CARD - WITH CONTROLLED SCROLLING */
    .app-card {
      background: white;
      border-radius: 24px;
      padding: 24px;
      height: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden; /* CRITICAL: Contain scrolling */
    }
    
    /* ================= CHAT MODAL ================= */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 0;
      backdrop-filter: blur(10px);
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* MODAL HEADER - FIXED */
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e5ea;
      background: white;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* CHAT AREA - SCROLLABLE CONTENT */
    .chat-area {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* CUSTOM SCROLLBAR */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* ================= CHAT MESSAGES ================= */
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      max-width: 85%;
    }
    
    .chat-message.sent {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    /* AVATAR - FIXED SIZE */
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: white;
    }
    
    /* BUBBLE */
    .chat-bubble {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: calc(100% - 50px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .chat-message:not(.sent) .chat-bubble {
      background: #f0f2f5;
      border-radius: 18px 18px 18px 4px;
    }
    
    .chat-message.sent .chat-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 18px 18px 4px 18px;
    }
    
    /* SENDER NAME */
    .chat-sender {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* BLOCKED INFO */
    .blocked-info {
      background: rgba(239, 68, 68, 0.1);
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 8px;
      border-left: 3px solid #dc2626;
    }
    
    .blocked-label {
      font-size: 11px;
      font-weight: 700;
      color: #dc2626;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .blocked-name {
      font-weight: 600;
      color: #7f1d1d;
      font-size: 15px;
    }
    
    .blocked-notes {
      font-size: 13px;
      color: #7f1d1d;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(220, 38, 38, 0.2);
    }
    
    /* TIMESTAMP */
    .chat-timestamp {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
      font-style: italic;
    }
    
    /* ================= ACCOUNT MODAL ================= */
    .account-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    
    .account-modal.active {
      display: flex;
    }
    
    .account-card {
      background: white;
      border-radius: 24px;
      max-width: 400px;
      width: 100%;
      padding: 32px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    /* ================= LIVE VIEWERS ================= */
    .live-viewers {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .live-dot {
      width: 8px;
      height: 8px;
      background: #ff4757;
      border-radius: 50%;
      animation: fadeIn 1.5s infinite alternate;
    }
    
    /* ================= LOADING STATES ================= */
    .loading-state {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    .loading-state.active {
      display: flex;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e5ea;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ================= RESPONSIVE ================= */
    @media (max-width: 640px) {
      #app-wrapper {
        padding: 10px;
      }
      
      .app-content {
        max-height: none;
      }
      
      .app-card {
        border-radius: 16px;
        padding: 16px;
      }
      
      .live-viewers {
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        font-size: 12px;
      }
    }
    
    /* ================= UTILITIES ================= */
    .hidden {
      display: none !important;
    }
    
    /* Prevent text selection */
    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* Smooth transitions */
    .smooth-transition {
      transition: all 0.3s ease;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body class="h-full no-select">
  <!-- Account Creation Modal -->
  <div id="account-modal" class="account-modal">
    <div class="account-card">
      <h2 class="text-2xl font-bold mb-2">üë§ Create Profile</h2>
      <p class="text-gray-600 mb-6">Set up once, contribute forever</p>
      
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2 text-left">Your Name</label>
        <input type="text" id="account-name" placeholder="Enter your name" 
               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <button id="create-account" class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
        Create Profile
      </button>
    </div>
  </div>

  <!-- Main App -->
  <div id="app-wrapper">
    <!-- Live Viewers Counter -->
    <div class="live-viewers">
      <span class="live-dot"></span>
      <span id="viewer-count">1</span>
      <span>online</span>
    </div>
    
    <!-- App Content -->
    <div class="app-content">
      <div class="app-card">
        <!-- User Profile -->
        <div id="user-profile" class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl mb-6">
          <div id="user-avatar" class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg">
            U
          </div>
          <div class="flex-1">
            <div id="user-name" class="font-semibold text-gray-800">User</div>
            <div class="text-xs text-gray-500">Ready to report</div>
          </div>
          <button id="switch-account" class="text-sm text-blue-600 hover:text-blue-800">Switch</button>
        </div>
        
        <!-- Title -->
        <div class="text-center mb-8">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
            <i class="fas fa-ban text-white text-2xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-gray-800 mb-2">Blocked List</h1>
          <p class="text-gray-600">Community safety warnings</p>
        </div>
        
        <!-- Form -->
        <form id="submission-form" class="space-y-4 mb-6">
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Blocked Person</label>
            <input type="text" id="name-input" placeholder="Name of person to block" required
                   class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Reason (Optional)</label>
            <textarea id="notes-input" rows="3" placeholder="Why this person should be blocked"
                      class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <button type="submit" id="submit-btn" 
                    class="py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
              <i class="fas fa-plus mr-2"></i>Report
            </button>
            
            <button type="button" id="view-chat-btn"
                    class="py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
              <i class="fas fa-comments mr-2"></i>View Chat
            </button>
          </div>
        </form>
        
        <!-- Success/Error Messages -->
        <div id="success-message" class="hidden p-4 bg-green-50 border-l-4 border-green-500 rounded-r mb-4">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <div>
              <p class="font-semibold text-green-800">Reported successfully!</p>
              <p class="text-sm text-green-600">The community has been warned.</p>
            </div>
          </div>
        </div>
        
        <div id="error-message" class="hidden p-4 bg-red-50 border-l-4 border-red-500 rounded-r mb-4">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
            <p id="error-text" class="font-semibold text-red-800">Error</p>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="mt-auto pt-4 border-t border-gray-200">
          <div class="grid grid-cols-3 gap-4 text-center">
            <div>
              <div id="total-reports" class="text-xl font-bold text-gray-800">0</div>
              <div class="text-xs text-gray-500">Total</div>
            </div>
            <div>
              <div id="your-reports" class="text-xl font-bold text-gray-800">0</div>
              <div class="text-xs text-gray-500">Your Reports</div>
            </div>
            <div>
              <div id="active-users" class="text-xl font-bold text-gray-800">1</div>
              <div class="text-xs text-gray-500">Online</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chat-modal" class="modal-overlay">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
            <i class="fas fa-ban text-white"></i>
          </div>
          <div>
            <h2 class="font-bold text-gray-800">Blocked List Chat</h2>
            <p id="chat-subtitle" class="text-xs text-gray-500">Loading...</p>
          </div>
        </div>
        <button id="close-chat" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">
          <i class="fas fa-times text-gray-600"></i>
        </button>
      </div>
      
      <!-- Chat Area -->
      <div class="chat-area">
        <!-- Loading -->
        <div id="chat-loading" class="loading-state active">
          <div class="spinner mb-4"></div>
          <p class="text-gray-600">Loading messages...</p>
        </div>
        
        <!-- Empty State -->
        <div id="chat-empty" class="loading-state hidden">
          <i class="fas fa-comment-slash text-gray-300 text-4xl mb-4"></i>
          <p class="text-gray-600 mb-2">No reports yet</p>
          <p class="text-sm text-gray-500">Be the first to warn the community</p>
          <button id="start-reporting" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm">
            Make First Report
          </button>
        </div>
        
        <!-- Error State -->
        <div id="chat-error" class="loading-state hidden">
          <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
          <p class="text-gray-600 mb-2">Failed to load</p>
          <button id="retry-chat" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm">
            Try Again
          </button>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-container" class="chat-container hidden"></div>
      </div>
    </div>
  </div>

  <!-- Hidden canvas for avatars -->
  <canvas id="avatar-canvas" class="hidden"></canvas>

  <script>
    // ============================================
    // REAL-TIME VIEWER COUNTER
    // ============================================
    class ViewerCounter {
      constructor() {
        this.viewers = 1;
        this.viewersData = {};
        this.interval = null;
        this.userId = this.generateUserId();
        this.lastActivity = Date.now();
      }
      
      generateUserId() {
        let id = localStorage.getItem('viewer_id');
        if (!id) {
          id = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('viewer_id', id);
        }
        return id;
      }
      
      updateActivity() {
        this.lastActivity = Date.now();
        this.viewersData[this.userId] = Date.now();
        localStorage.setItem('viewers_data', JSON.stringify(this.viewersData));
      }
      
      countActiveViewers() {
        try {
          const data = localStorage.getItem('viewers_data');
          if (!data) return 1;
          
          const viewers = JSON.parse(data);
          const now = Date.now();
          let activeCount = 0;
          
          // Clean up old entries and count active
          for (const [id, timestamp] of Object.entries(viewers)) {
            if (now - timestamp < 60000) { // 60 seconds
              activeCount++;
              this.viewersData[id] = timestamp;
            }
          }
          
          // Add current user
          this.viewersData[this.userId] = now;
          activeCount = Math.max(activeCount, 1);
          
          // Update display
          this.viewers = activeCount;
          document.getElementById('viewer-count').textContent = activeCount;
          document.getElementById('active-users').textContent = activeCount;
          
          // Save updated data
          localStorage.setItem('viewers_data', JSON.stringify(this.viewersData));
          
          return activeCount;
        } catch (error) {
          return 1;
        }
      }
      
      start() {
        // Initial count
        this.countActiveViewers();
        this.updateActivity();
        
        // Update every 5 seconds
        this.interval = setInterval(() => {
          this.countActiveViewers();
        }, 5000);
        
        // Update on user activity
        ['click', 'mousemove', 'keydown'].forEach(event => {
          window.addEventListener(event, () => {
            if (Date.now() - this.lastActivity > 1000) {
              this.updateActivity();
              this.countActiveViewers();
            }
          });
        });
        
        // Update when tab becomes visible
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.updateActivity();
            this.countActiveViewers();
          }
        });
      }
      
      stop() {
        if (this.interval) {
          clearInterval(this.interval);
        }
      }
    }
    
    // ============================================
    // USER ACCOUNT MANAGER
    // ============================================
    class UserManager {
      static STORAGE_KEY = 'blocked_user_account';
      
      static createAccount(name) {
        const account = {
          id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name: name.trim(),
          color: this.generateColor(name),
          createdAt: Date.now(),
          reportCount: 0
        };
        
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(account));
        return account;
      }
      
      static getAccount() {
        const data = localStorage.getItem(this.STORAGE_KEY);
        if (!data) return null;
        
        try {
          return JSON.parse(data);
        } catch (error) {
          return null;
        }
      }
      
      static updateAccount(updates) {
        const account = this.getAccount();
        if (!account) return null;
        
        const updated = { ...account, ...updates };
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(updated));
        return updated;
      }
      
      static incrementReportCount() {
        const account = this.getAccount();
        if (!account) return 0;
        
        const count = (account.reportCount || 0) + 1;
        this.updateAccount({ reportCount: count });
        return count;
      }
      
      static generateColor(name) {
        const colors = [
          '#667eea', '#764ba2', '#f56565', '#ed8936', '#ecc94b',
          '#48bb78', '#38b2ac', '#4299e1', '#9f7aea', '#ed64a6'
        ];
        
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        return colors[Math.abs(hash) % colors.length];
      }
      
      static getInitials(name) {
        return name
          .split(' ')
          .map(word => word[0])
          .join('')
          .toUpperCase()
          .slice(0, 2);
      }
    }
    
    // ============================================
    // CHAT MANAGER
    // ============================================
    class ChatManager {
      constructor() {
        this.messages = [];
        this.lastUpdate = 0;
        this.updateInterval = null;
      }
      
      async loadMessages() {
        try {
          const sheetId = '1KKB-uxdVFvRSGHex192unt9D691Zh9SwUILXtD5Q7GM';
          const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&t=${Date.now()}`;
          
          const response = await fetch(csvUrl);
          const csvText = await response.text();
          const rows = this.parseCSV(csvText);
          
          if (rows.length < 2) return [];
          
          const headers = rows[0];
          const nameIndex = headers.findIndex(h => h && h.toLowerCase().includes('name'));
          const notesIndex = headers.findIndex(h => h && h.toLowerCase().includes('note'));
          
          const messages = [];
          
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const name = nameIndex >= 0 ? (row[nameIndex] || '').trim() : '';
            const notes = notesIndex >= 0 ? (row[notesIndex] || '').trim() : '';
            
            if (name) {
              // Extract timestamp from notes (if any)
              let timestamp = new Date();
              let cleanNotes = notes;
              
              // Try to find timestamp in format like "2:30 PM"
              const timeMatch = notes.match(/(\d{1,2}:\d{2}\s*(?:AM|PM)?)/i);
              if (timeMatch) {
                try {
                  timestamp = new Date(timeMatch[0]);
                  if (isNaN(timestamp.getTime())) {
                    timestamp = new Date();
                  }
                } catch (e) {
                  timestamp = new Date();
                }
              }
              
              messages.push({
                name: name,
                notes: cleanNotes,
                timestamp: timestamp,
                rowIndex: i
              });
            }
          }
          
          // Sort by timestamp (newest first for display)
          messages.sort((a, b) => b.timestamp - a.timestamp);
          this.messages = messages;
          
          return messages;
        } catch (error) {
          console.error('Error loading messages:', error);
          throw error;
        }
      }
      
      parseCSV(csvText) {
        const rows = [];
        let row = [];
        let cell = '';
        let inQuotes = false;
        
        for (let i = 0; i < csvText.length; i++) {
          const char = csvText[i];
          const next = csvText[i + 1];
          
          if (char === '"') {
            if (inQuotes && next === '"') {
              cell += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            row.push(cell);
            cell = '';
          } else if (char === '\n' && !inQuotes) {
            row.push(cell);
            rows.push(row);
            row = [];
            cell = '';
          } else if (char === '\r' && next === '\n' && !inQuotes) {
            row.push(cell);
            rows.push(row);
            row = [];
            cell = '';
            i++;
          } else {
            cell += char;
          }
        }
        
        if (cell || row.length) {
          row.push(cell);
          rows.push(row);
        }
        
        return rows;
      }
      
      startAutoRefresh(callback) {
        if (this.updateInterval) {
          clearInterval(this.updateInterval);
        }
        
        this.updateInterval = setInterval(async () => {
          try {
            await this.loadMessages();
            if (callback) callback(this.messages);
          } catch (error) {
            console.error('Auto-refresh error:', error);
          }
        }, 10000); // Refresh every 10 seconds
      }
      
      stopAutoRefresh() {
        if (this.updateInterval) {
          clearInterval(this.updateInterval);
          this.updateInterval = null;
        }
      }
    }
    
    // ============================================
    // APPLICATION
    // ============================================
    class BlockedListApp {
      constructor() {
        this.user = null;
        this.viewerCounter = new ViewerCounter();
        this.chatManager = new ChatManager();
        this.isChatOpen = false;
        this.initialize();
      }
      
      initialize() {
        this.bindEvents();
        this.checkAccount();
      }
      
      bindEvents() {
        // Account creation
        document.getElementById('create-account').addEventListener('click', () => this.createAccount());
        document.getElementById('account-name').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.createAccount();
        });
        
        // Switch account
        document.getElementById('switch-account').addEventListener('click', () => this.switchAccount());
        
        // Form submission
        document.getElementById('submission-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitReport();
        });
        
        // Chat modal
        document.getElementById('view-chat-btn').addEventListener('click', () => this.openChat());
        document.getElementById('close-chat').addEventListener('click', () => this.closeChat());
        document.getElementById('start-reporting').addEventListener('click', () => this.closeChat());
        document.getElementById('retry-chat').addEventListener('click', () => this.loadChat());
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isChatOpen) {
            this.closeChat();
          }
        });
        
        // Click outside to close chat
        document.getElementById('chat-modal').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            this.closeChat();
          }
        });
      }
      
      checkAccount() {
        this.user = UserManager.getAccount();
        
        if (!this.user) {
          this.showAccountModal();
        } else {
          this.showMainApp();
        }
      }
      
      showAccountModal() {
        document.getElementById('account-modal').classList.add('active');
        document.getElementById('app-wrapper').style.display = 'none';
        document.getElementById('account-name').focus();
      }
      
      showMainApp() {
        document.getElementById('account-modal').classList.remove('active');
        document.getElementById('app-wrapper').style.display = 'flex';
        this.updateUserProfile();
        this.viewerCounter.start();
        this.updateStats();
      }
      
      createAccount() {
        const nameInput = document.getElementById('account-name');
        const name = nameInput.value.trim();
        
        if (!name) {
          alert('Please enter your name');
          return;
        }
        
        this.user = UserManager.createAccount(name);
        this.showMainApp();
      }
      
      switchAccount() {
        if (confirm('Create a new account? Current account will be removed.')) {
          localStorage.removeItem(UserManager.STORAGE_KEY);
          this.user = null;
          this.showAccountModal();
        }
      }
      
      updateUserProfile() {
        if (!this.user) return;
        
        const initials = UserManager.getInitials(this.user.name);
        const color = this.user.color;
        
        document.getElementById('user-avatar').textContent = initials;
        document.getElementById('user-avatar').style.background = color;
        document.getElementById('user-name').textContent = this.user.name;
        
        // Update your reports count
        document.getElementById('your-reports').textContent = this.user.reportCount || 0;
      }
      
      async submitReport() {
        if (!this.user) {
          alert('Please create an account first');
          return;
        }
        
        const nameInput = document.getElementById('name-input');
        const notesInput = document.getElementById('notes-input');
        const submitBtn = document.getElementById('submit-btn');
        
        const blockedName = nameInput.value.trim();
        if (!blockedName) {
          alert('Please enter a name');
          return;
        }
        
        // Show loading
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Reporting...';
        submitBtn.disabled = true;
        
        try {
          // Format notes with timestamp (NO "Reported by")
          const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const notes = notesInput.value.trim() + 
            (notesInput.value.trim() ? ' ‚Ä¢ ' : '') + 
            `‚è∞ ${timestamp}`;
          
          // Submit to Google Forms
          const formData = new FormData();
          formData.append('entry.714302158', blockedName);
          formData.append('entry.1541466423', notes);
          
          await fetch('https://docs.google.com/forms/d/e/1FAIpQLSfOzXT3fXroXRTYQ7J--pMWvpdJ_FPmXAvDNLS3z-UnYnti5g/formResponse', {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
          });
          
          // Update user stats
          UserManager.incrementReportCount();
          this.user = UserManager.getAccount();
          this.updateUserProfile();
          
          // Show success
          this.showSuccess('Report submitted successfully!');
          
          // Clear form
          nameInput.value = '';
          notesInput.value = '';
          nameInput.focus();
          
          // Refresh chat if open
          if (this.isChatOpen) {
            await this.loadChat();
          }
          
        } catch (error) {
          console.error('Submission error:', error);
          this.showError('Failed to submit. Please try again.');
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
      
      showSuccess(message) {
        const successEl = document.getElementById('success-message');
        successEl.querySelector('p').textContent = message;
        successEl.classList.remove('hidden');
        
        setTimeout(() => {
          successEl.classList.add('hidden');
        }, 3000);
      }
      
      showError(message) {
        const errorEl = document.getElementById('error-message');
        document.getElementById('error-text').textContent = message;
        errorEl.classList.remove('hidden');
        
        setTimeout(() => {
          errorEl.classList.add('hidden');
        }, 5000);
      }
      
      updateStats() {
        // Update total reports
        this.chatManager.loadMessages().then(messages => {
          document.getElementById('total-reports').textContent = messages.length;
        }).catch(() => {
          document.getElementById('total-reports').textContent = '0';
        });
        
        // Update online users
        this.viewerCounter.countActiveViewers();
      }
      
      async openChat() {
        this.isChatOpen = true;
        document.getElementById('chat-modal').classList.add('active');
        await this.loadChat();
        
        // Start auto-refresh
        this.chatManager.startAutoRefresh((messages) => {
          this.displayChat(messages);
        });
      }
      
      closeChat() {
        this.isChatOpen = false;
        document.getElementById('chat-modal').classList.remove('active');
        this.chatManager.stopAutoRefresh();
      }
      
      async loadChat() {
        const loadingEl = document.getElementById('chat-loading');
        const emptyEl = document.getElementById('chat-empty');
        const errorEl = document.getElementById('chat-error');
        const chatEl = document.getElementById('chat-container');
        
        loadingEl.classList.add('active');
        emptyEl.classList.add('hidden');
        errorEl.classList.add('hidden');
        chatEl.classList.add('hidden');
        
        try {
          const messages = await this.chatManager.loadMessages();
          
          if (messages.length === 0) {
            loadingEl.classList.remove('active');
            emptyEl.classList.remove('hidden');
          } else {
            this.displayChat(messages);
            loadingEl.classList.remove('active');
            chatEl.classList.remove('hidden');
          }
          
          // Update subtitle
          document.getElementById('chat-subtitle').textContent = 
            `${messages.length} report${messages.length !== 1 ? 's' : ''}`;
            
        } catch (error) {
          console.error('Chat load error:', error);
          loadingEl.classList.remove('active');
          errorEl.classList.remove('hidden');
        }
      }
      
      displayChat(messages) {
        const chatContainer = document.getElementById('chat-container');
        const currentUser = this.user;
        
        chatContainer.innerHTML = '';
        
        // Display messages (newest at bottom)
        messages.forEach((msg, index) => {
          const messageEl = document.createElement('div');
          
          // Check if this is current user's message (based on timestamp pattern)
          const isCurrentUser = msg.notes && msg.notes.includes('‚è∞');
          
          // Get user color based on name hash
          const userColor = UserManager.generateColor(msg.name || 'Anonymous');
          const userInitials = UserManager.getInitials(msg.name || 'An');
          
          messageEl.className = `chat-message ${isCurrentUser ? 'sent slide-in' : 'slide-in'}`;
          messageEl.style.animationDelay = `${index * 0.05}s`;
          
          // Format timestamp
          const timeString = msg.timestamp.toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
          });
          
          const dateString = msg.timestamp.toLocaleDateString([], {
            month: 'short',
            day: 'numeric'
          });
          
          messageEl.innerHTML = `
            <div class="chat-avatar" style="background: ${userColor}">
              ${userInitials}
            </div>
            <div class="chat-bubble">
              <div class="chat-sender">
                <i class="fas fa-user"></i>
                ${msg.name || 'Anonymous'}
              </div>
              
              ${msg.notes ? `
              <div class="text-sm mt-1">${this.escapeHtml(msg.notes)}</div>
              ` : ''}
              
              <div class="chat-timestamp">
                <i class="far fa-clock"></i>
                ${timeString} ‚Ä¢ ${dateString}
              </div>
            </div>
          `;
          
          chatContainer.appendChild(messageEl);
        });
        
        // Scroll to bottom (newest messages)
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
      }
      
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }
    
    // ============================================
    // INITIALIZE APPLICATION
    // ============================================
    // Prevent default touch behaviors that cause scrolling
    document.addEventListener('touchmove', (e) => {
      if (e.target.classList.contains('chat-container') || 
          e.target.closest('.chat-container')) {
        return; // Allow scrolling in chat
      }
      e.preventDefault();
    }, { passive: false });
    
    // Prevent pull-to-refresh
    document.addEventListener('touchstart', (e) => {
      if (e.touches.length !== 1) return;
      const touch = e.touches[0];
      if (touch.clientY < 10) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // Initialize app when page loads
    window.addEventListener('DOMContentLoaded', () => {
      window.app = new BlockedListApp();
    });
    
    // Force no-scroll on body at all times
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
  </script>
</body>
</html>
