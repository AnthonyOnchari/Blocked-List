<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocked List Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <!-- Firebase for real-time viewer count -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Outfit', sans-serif;
    }
    
    /* Prevent scrolling on body */
    body {
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
    .slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
    .pulse { animation: pulse 2s infinite; }
    
    /* Main app - FIXED NO SCROLL */
    #app-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* Scrollable content area INSIDE app */
    .app-content {
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Custom scrollbar */
    .app-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .app-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    .app-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    
    .app-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* Chat modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 0;
      backdrop-filter: blur(10px);
    }
    
    .modal-content {
      background: white;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: none;
    }
    
    /* Modal header - fixed top */
    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid #e5e5ea;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* Chat container - scrollable */
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      min-height: 0; /* Important for flex scroll */
    }
    
    /* Chat scrollbar */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Chat message styles */
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      max-width: 100%;
    }
    
    .chat-message.sent {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    /* PROFILE PICTURES - FIXED to show actual images */
    .chat-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 3px solid;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
      overflow: hidden;
    }
    
    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .chat-message:not(.sent) .chat-avatar {
      border-color: #e5e5ea;
    }
    
    .chat-message.sent .chat-avatar {
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    .chat-bubble {
      padding: 14px 18px;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      max-width: 75%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .chat-message:not(.sent) .chat-bubble {
      background-color: #ffffff;
      border: 1px solid #e5e5ea;
      border-radius: 20px 20px 20px 5px;
    }
    
    .chat-message.sent .chat-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px 20px 5px 20px;
    }
    
    .chat-sender {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .chat-message:not(.sent) .chat-sender {
      color: #4a5568;
    }
    
    .chat-message.sent .chat-sender {
      color: rgba(255, 255, 255, 0.95);
    }
    
    .chat-time {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 8px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 5px;
    }
    
    .blocked-info {
      background-color: rgba(239, 68, 68, 0.12);
      padding: 12px 14px;
      border-radius: 14px;
      margin-top: 10px;
      border-left: 4px solid #dc2626;
    }
    
    .blocked-label {
      font-size: 12px;
      font-weight: 800;
      color: #dc2626;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .blocked-name {
      font-weight: 700;
      color: #7f1d1d;
      font-size: 16px;
    }
    
    .blocked-notes {
      font-size: 14px;
      color: #7f1d1d;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(220, 38, 38, 0.2);
    }
    
    /* Account modal */
    .account-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }
    
    .account-card {
      background: white;
      border-radius: 24px;
      max-width: 440px;
      width: 100%;
      padding: 40px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .avatar-preview-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 25px;
    }
    
    .avatar-preview {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid #667eea;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .avatar-change-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      border: 3px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    /* User profile in form */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 16px;
      background: rgba(102, 126, 234, 0.08);
      border-radius: 16px;
      margin-bottom: 24px;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .user-profile-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #667eea;
    }
    
    .user-profile-info {
      flex: 1;
      text-align: left;
    }
    
    .user-profile-name {
      font-weight: 700;
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 4px;
    }
    
    .user-profile-status {
      font-size: 13px;
      color: #718096;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* Live viewers indicator */
    .live-viewers {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .live-dot {
      width: 8px;
      height: 8px;
      background: #ff4757;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    
    .viewer-count {
      font-weight: bold;
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .modal-content {
        border-radius: 0;
      }
      
      .account-card {
        padding: 30px 20px;
      }
      
      .live-viewers {
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body class="h-full">
  <!-- Account Setup Modal -->
  <div id="account-modal" class="account-modal">
    <div class="account-card">
      <div class="mb-8">
        <h2 class="text-3xl font-bold mb-3" style="color: #2d3748;">ðŸ‘¤ Create Your Profile</h2>
        <p class="text-sm" style="color: #718096;">Set up once, then start contributing to the community</p>
      </div>
      
      <div class="avatar-preview-container">
        <div id="avatar-preview" class="avatar-preview">
          <div class="w-full h-full flex items-center justify-center text-white text-2xl font-bold" id="avatar-initials">U</div>
        </div>
        <div class="avatar-change-btn" id="avatar-upload-trigger">
          <i class="fas fa-camera"></i>
        </div>
        <input type="file" id="avatar-upload" accept="image/*" class="hidden">
      </div>
      
      <form id="account-form" class="space-y-6">
        <div>
          <label for="account-name" class="block text-sm font-semibold mb-3 text-left" style="color: #2d3748;">
            <i class="fas fa-user mr-2"></i>Your Name <span class="text-red-500">*</span>
          </label>
          <input type="text" id="account-name" required 
                 placeholder="Enter your full name..."
                 class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition-all"
                 style="border-color: #e2e8f0; color: #2d3748;">
        </div>
        
        <button type="submit" class="w-full py-3 rounded-xl font-bold text-white text-lg transition-all hover:scale-105 active:scale-95 shadow-lg" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <i class="fas fa-rocket mr-2"></i> Create Profile
        </button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="app-wrapper" class="hidden">
    <!-- Live Viewers Counter -->
    <div class="live-viewers" id="live-viewers">
      <span class="live-dot"></span>
      <span class="viewer-count" id="viewer-count">1</span>
      <span>online</span>
    </div>
    
    <!-- Scrollable Content Area -->
    <div class="app-content">
      <div class="min-h-full w-full flex flex-col items-center justify-center py-8 px-4">
        <div class="w-full max-w-lg">
          <!-- Form Card -->
          <div class="rounded-3xl p-8 shadow-2xl" style="background-color: #ffffff;">
            <!-- User Profile -->
            <div id="user-profile-display" class="user-profile">
              <div class="relative">
                <div id="current-user-avatar" class="user-profile-img">
                  <div class="w-full h-full flex items-center justify-center text-white text-xl font-bold" id="current-user-initials">U</div>
                </div>
                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white"></div>
              </div>
              <div class="user-profile-info">
                <div id="current-user-name" class="user-profile-name">Loading...</div>
                <div class="user-profile-status">
                  <i class="fas fa-circle text-green-500"></i>
                  <span id="user-status-text">Online</span>
                </div>
              </div>
              <button type="button" id="change-account-btn" class="px-4 py-2 rounded-lg font-medium text-white"
                      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-exchange-alt mr-2"></i> Switch
              </button>
            </div>
            
            <!-- Header -->
            <div class="text-center mb-10">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center shadow-lg" 
                   style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-ban text-white text-3xl"></i>
              </div>
              <h1 id="form-title" class="text-3xl font-bold mb-3" style="color: #2d3748;">Blocked List Chat</h1>
              <p id="form-description" class="text-base" style="color: #718096;">Community safety warnings</p>
            </div>
            
            <!-- Form -->
            <form id="submission-form" class="space-y-6">
              <div>
                <label for="name-input" class="block text-sm font-semibold mb-3" style="color: #2d3748;">
                  <i class="fas fa-user-slash mr-2"></i>Blocked Person <span class="text-red-500">*</span>
                </label>
                <input type="text" id="name-input" name="name" required 
                       placeholder="Enter name of person to block..." 
                       class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition-all"
                       style="border-color: #e2e8f0; color: #2d3748;">
              </div>
              
              <div>
                <label for="notes-input" class="block text-sm font-semibold mb-3" style="color: #2d3748;">
                  <i class="fas fa-sticky-note mr-2"></i>Reason / Details
                </label>
                <textarea id="notes-input" name="notes" rows="4" 
                          placeholder="Why should this person be blocked?..." 
                          class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition-all resize-none"
                          style="border-color: #e2e8f0; color: #2d3748;"></textarea>
              </div>
              
              <!-- Action Buttons -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button type="submit" id="submit-btn" class="w-full py-4 rounded-xl font-bold text-white text-lg transition-all hover:scale-105 active:scale-95 shadow-lg"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <i class="fas fa-plus-circle mr-2"></i>
                  <span id="submit-text">Add to List</span>
                </button>
                
                <button type="button" id="view-list-btn" class="w-full py-4 rounded-xl font-bold text-white text-lg transition-all hover:scale-105 active:scale-95 shadow-lg"
                        style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                  <i class="fas fa-comments mr-2"></i>
                  <span id="view-text">View Chat</span>
                </button>
              </div>
            </form>
            
            <!-- Success/Error Messages -->
            <div id="success-message" class="hidden mt-6 p-4 rounded-xl fade-in" style="background-color: #d4edda; border-left: 4px solid #28a745;">
              <div class="flex items-center">
                <i class="fas fa-check-circle mr-3 text-green-500"></i>
                <p class="font-semibold" style="color: #155724;">Added to blocked list!</p>
              </div>
            </div>
            
            <div id="error-message" class="hidden mt-6 p-4 rounded-xl fade-in" style="background-color: #f8d7da; border-left: 4px solid #dc3545;">
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-3 text-red-500"></i>
                <p class="font-semibold" style="color: #721c24;" id="error-text">Error</p>
              </div>
            </div>
            
            <!-- Stats -->
            <div class="mt-8 pt-6 border-t border-gray-200">
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold" style="color: #667eea;" id="total-reports">0</div>
                  <div class="text-xs" style="color: #718096;">Total Reports</div>
                </div>
                <div>
                  <div class="text-2xl font-bold" style="color: #764ba2;" id="your-reports">0</div>
                  <div class="text-xs" style="color: #718096;">Your Reports</div>
                </div>
                <div>
                  <div class="text-2xl font-bold" style="color: #4CAF50;" id="community-size">1</div>
                  <div class="text-xs" style="color: #718096;">Community</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Footer -->
          <p class="text-center mt-6 text-sm text-white opacity-90">
            <i class="fas fa-shield-alt mr-2"></i> Community Safety Network
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="list-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-md" 
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-ban text-white text-xl"></i>
          </div>
          <div>
            <h2 class="text-xl font-bold" style="color: #2d3748;">Blocked List Chat</h2>
            <p class="text-sm" style="color: #718096;" id="chat-subtitle">Community warnings</p>
          </div>
        </div>
        <button id="close-modal" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100">
          <i class="fas fa-times text-gray-600"></i>
        </button>
      </div>
      
      <!-- Chat Container - SCROLLABLE CONTENT -->
      <div class="chat-container" id="list-body">
        <!-- Messages will appear here -->
      </div>
      
      <!-- Loading State -->
      <div id="loading-state" class="hidden h-full flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-600">Loading chat...</p>
      </div>
      
      <!-- No Data -->
      <div id="no-data" class="hidden h-full flex flex-col items-center justify-center p-8">
        <i class="fas fa-comment-slash text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-xl font-bold text-gray-600 mb-2">No warnings yet</h3>
        <p class="text-gray-500 text-center mb-6">Be the first to warn the community</p>
        <button id="close-modal-add" class="px-6 py-3 rounded-lg text-white font-medium"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <i class="fas fa-plus-circle mr-2"></i> Add First Warning
        </button>
      </div>
      
      <!-- Error State -->
      <div id="list-error" class="hidden h-full flex flex-col items-center justify-center p-8">
        <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
        <h3 class="text-xl font-bold text-gray-600 mb-2">Connection Error</h3>
        <p class="text-gray-500 text-center mb-6" id="list-error-text">Failed to load chat</p>
        <button id="retry-load" class="px-6 py-3 rounded-lg text-white font-medium"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <i class="fas fa-redo mr-2"></i> Try Again
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden canvas for avatars -->
  <canvas id="avatar-canvas" class="hidden"></canvas>

  <script>
    // ============================================
    // REAL-TIME VIEWER COUNTER SYSTEM
    // ============================================
    class ViewerCounter {
      constructor() {
        this.viewers = 0;
        this.userId = null;
        this.isConnected = false;
        this.lastUpdate = Date.now();
      }
      
      // Generate unique user ID for this session
      getUserId() {
        if (!this.userId) {
          this.userId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('viewerId', this.userId);
        }
        return this.userId;
      }
      
      // Simple serverless viewer counter using localStorage and timestamps
      updateViewerCount() {
        try {
          const now = Date.now();
          const userId = this.getUserId();
          const viewersKey = 'blockedList_viewers';
          const viewersData = JSON.parse(localStorage.getItem(viewersKey) || '{}');
          
          // Clean up old entries (older than 30 seconds)
          Object.keys(viewersData).forEach(key => {
            if (now - viewersData[key] > 30000) { // 30 seconds
              delete viewersData[key];
            }
          });
          
          // Add/update current user
          viewersData[userId] = now;
          
          // Save back to localStorage
          localStorage.setItem(viewersKey, JSON.stringify(viewersData));
          
          // Count active viewers
          const activeViewers = Object.keys(viewersData).length;
          this.viewers = activeViewers;
          
          // Update display
          document.getElementById('viewer-count').textContent = activeViewers;
          document.getElementById('community-size').textContent = activeViewers;
          
          return activeViewers;
        } catch (error) {
          console.error('Viewer counter error:', error);
          return 1; // Fallback to at least 1 (current user)
        }
      }
      
      // Start updating viewer count periodically
      start() {
        // Initial update
        this.updateViewerCount();
        
        // Update every 10 seconds
        this.interval = setInterval(() => {
          this.updateViewerCount();
        }, 10000);
        
        // Update when page becomes visible
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.updateViewerCount();
          }
        });
        
        // Update on user activity
        ['click', 'mousemove', 'keydown', 'scroll'].forEach(event => {
          document.addEventListener(event, () => {
            if (Date.now() - this.lastUpdate > 5000) {
              this.updateViewerCount();
              this.lastUpdate = Date.now();
            }
          });
        });
      }
      
      stop() {
        if (this.interval) {
          clearInterval(this.interval);
        }
      }
    }
    
    // Initialize viewer counter
    const viewerCounter = new ViewerCounter();
    
    // ============================================
    // USER ACCOUNT SYSTEM
    // ============================================
    class UserAccount {
      static STORAGE_KEY = 'blockedListUserAccount';
      
      static createAccount(name, avatarData = null) {
        const account = {
          id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 12),
          name: name.trim(),
          avatar: avatarData, // Store actual image data
          createdAt: new Date().toISOString(),
          reportCount: 0,
          lastActive: new Date().toISOString()
        };
        
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(account));
        return account;
      }
      
      static getAccount() {
        const data = localStorage.getItem(this.STORAGE_KEY);
        if (!data) return null;
        
        try {
          return JSON.parse(data);
        } catch (e) {
          return null;
        }
      }
      
      static updateAccount(updates) {
        const account = this.getAccount();
        if (!account) return null;
        
        const updated = { ...account, ...updates, lastActive: new Date().toISOString() };
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(updated));
        return updated;
      }
      
      static incrementReportCount() {
        const account = this.getAccount();
        if (!account) return 0;
        
        const count = (account.reportCount || 0) + 1;
        this.updateAccount({ reportCount: count });
        return count;
      }
      
      static getAvatarData(account) {
        if (!account || !account.avatar) return null;
        return account.avatar;
      }
      
      static generateInitials(name) {
        return name
          .split(' ')
          .map(word => word[0])
          .join('')
          .toUpperCase()
          .slice(0, 2);
      }
      
      static getInitials(account) {
        if (!account) return '?';
        return this.generateInitials(account.name);
      }
      
      static async processAvatarImage(file) {
        return new Promise((resolve, reject) => {
          if (!file.type.startsWith('image/')) {
            reject('Please select an image file');
            return;
          }
          
          if (file.size > 2 * 1024 * 1024) {
            reject('Image must be less than 2MB');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.getElementById('avatar-canvas');
              const ctx = canvas.getContext('2d');
              
              // Set canvas size
              const size = 400;
              canvas.width = size;
              canvas.height = size;
              
              // Create circular mask
              ctx.clearRect(0, 0, size, size);
              ctx.beginPath();
              ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
              ctx.closePath();
              ctx.clip();
              
              // Draw image
              ctx.drawImage(img, 0, 0, size, size);
              
              // Get data URL
              const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
              resolve(dataUrl);
            };
            img.onerror = () => reject('Failed to load image');
            img.src = e.target.result;
          };
          reader.onerror = () => reject('Failed to read file');
          reader.readAsDataURL(file);
        });
      }
    }
    
    // ============================================
    // APPLICATION INITIALIZATION
    // ============================================
    const accountModal = document.getElementById('account-modal');
    const appWrapper = document.getElementById('app-wrapper');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarUpload = document.getElementById('avatar-upload');
    const avatarUploadTrigger = document.getElementById('avatar-upload-trigger');
    const avatarInitials = document.getElementById('avatar-initials');
    const accountForm = document.getElementById('account-form');
    const currentUserAvatar = document.getElementById('current-user-avatar');
    const currentUserInitials = document.getElementById('current-user-initials');
    const currentUserName = document.getElementById('current-user-name');
    const changeAccountBtn = document.getElementById('change-account-btn');
    const submissionForm = document.getElementById('submission-form');
    const submitBtn = document.getElementById('submit-btn');
    const viewListBtn = document.getElementById('view-list-btn');
    const listModal = document.getElementById('list-modal');
    const closeModal = document.getElementById('close-modal');
    const closeModalAdd = document.getElementById('close-modal-add');
    const listBody = document.getElementById('list-body');
    const loadingState = document.getElementById('loading-state');
    const noData = document.getElementById('no-data');
    const listError = document.getElementById('list-error');
    const retryLoad = document.getElementById('retry-load');
    
    let currentUser = null;
    let allMessages = [];
    
    // Initialize app
    function initApp() {
      const account = UserAccount.getAccount();
      
      if (!account) {
        showAccountModal();
      } else {
        currentUser = account;
        showMainApp();
        viewerCounter.start(); // Start viewer counter
      }
    }
    
    function showAccountModal() {
      accountModal.classList.remove('hidden');
      appWrapper.classList.add('hidden');
      document.getElementById('account-name').focus();
    }
    
    function showMainApp() {
      accountModal.classList.add('hidden');
      appWrapper.classList.remove('hidden');
      updateUserProfile();
      updateStats();
      document.getElementById('name-input').focus();
    }
    
    function updateUserProfile() {
      if (!currentUser) return;
      
      currentUserName.textContent = currentUser.name;
      currentUserInitials.textContent = UserAccount.getInitials(currentUser);
      
      // Set avatar background color based on name hash
      const hash = currentUser.name.split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0);
      
      const colors = [
        '#667eea', '#764ba2', '#f56565', '#ed8936', '#ecc94b',
        '#48bb78', '#38b2ac', '#4299e1', '#9f7aea', '#ed64a6'
      ];
      const color = colors[Math.abs(hash) % colors.length];
      
      currentUserAvatar.style.background = color;
      
      // If user has uploaded avatar, use it
      const avatarData = UserAccount.getAvatarData(currentUser);
      if (avatarData) {
        currentUserAvatar.innerHTML = `<img src="${avatarData}" alt="${currentUser.name}">`;
      }
    }
    
    function updateStats() {
      if (!currentUser) return;
      
      document.getElementById('your-reports').textContent = currentUser.reportCount || 0;
      viewerCounter.updateViewerCount(); // Update viewer count
    }
    
    // Avatar upload
    avatarUploadTrigger.addEventListener('click', () => avatarUpload.click());
    
    avatarUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const avatarData = await UserAccount.processAvatarImage(file);
        avatarPreview.innerHTML = `<img src="${avatarData}" alt="Avatar">`;
      } catch (error) {
        alert(error);
      }
    });
    
    // Update avatar initials when name changes
    document.getElementById('account-name').addEventListener('input', (e) => {
      const initials = UserAccount.generateInitials(e.target.value || 'User');
      avatarInitials.textContent = initials;
    });
    
    // Account creation
    accountForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nameInput = document.getElementById('account-name');
      if (!nameInput.value.trim()) {
        alert('Please enter your name');
        return;
      }
      
      // Get avatar data from preview
      const avatarImg = avatarPreview.querySelector('img');
      const avatarData = avatarImg ? avatarImg.src : null;
      
      currentUser = UserAccount.createAccount(nameInput.value.trim(), avatarData);
      showMainApp();
    });
    
    // Change account
    changeAccountBtn.addEventListener('click', () => {
      if (confirm('Switch to different account?')) {
        localStorage.removeItem(UserAccount.STORAGE_KEY);
        showAccountModal();
      }
    });
    
    // Form submission
    submissionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        alert('Please create an account first');
        return;
      }
      
      const nameInput = document.getElementById('name-input');
      const notesInput = document.getElementById('notes-input');
      
      if (!nameInput.value.trim()) {
        alert('Please enter a name');
        return;
      }
      
      submitBtn.disabled = true;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Adding...';
      
      try {
        const FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfOzXT3fXroXRTYQ7J--pMWvpdJ_FPmXAvDNLS3z-UnYnti5g/formResponse';
        const formData = new FormData();
        formData.append('entry.714302158', nameInput.value.trim());
        
        // Add user info to notes
        const timestamp = new Date().toLocaleString();
        const fullNotes = (notesInput.value.trim() ? notesInput.value.trim() + '\n\n' : '') +
          `ðŸ‘¤ Reported by: ${currentUser.name} â€¢ â° ${timestamp}`;
        
        formData.append('entry.1541466423', fullNotes);
        
        await fetch(FORM_ACTION_URL, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        });
        
        // Update user stats
        UserAccount.incrementReportCount();
        currentUser = UserAccount.getAccount();
        updateStats();
        
        // Show success
        document.getElementById('success-message').classList.remove('hidden');
        document.getElementById('error-message').classList.add('hidden');
        
        // Reset form
        nameInput.value = '';
        notesInput.value = '';
        nameInput.focus();
        
        // Hide success after 3 seconds
        setTimeout(() => {
          document.getElementById('success-message').classList.add('hidden');
        }, 3000);
        
      } catch (error) {
        document.getElementById('error-text').textContent = 'Failed to submit. Please try again.';
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('success-message').classList.add('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });
    
    // View chat
    viewListBtn.addEventListener('click', async () => {
      listModal.classList.remove('hidden');
      await loadChat();
    });
    
    // Close modal
    closeModal.addEventListener('click', () => {
      listModal.classList.add('hidden');
    });
    
    closeModalAdd.addEventListener('click', () => {
      listModal.classList.add('hidden');
      document.getElementById('name-input').focus();
    });
    
    // Retry loading
    retryLoad.addEventListener('click', loadChat);
    
    // Load chat data
    async function loadChat() {
      loadingState.classList.remove('hidden');
      listBody.classList.add('hidden');
      noData.classList.add('hidden');
      listError.classList.add('hidden');
      
      try {
        const sheetId = '1KKB-uxdVFvRSGHex192unt9D691Zh9SwUILXtD5Q7GM';
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
        
        const response = await fetch(csvUrl);
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        
        allMessages = [];
        
        if (rows.length <= 1) {
          showNoData();
          return;
        }
        
        // Process rows
        const headers = rows[0];
        const nameIndex = headers.findIndex(h => h && h.toLowerCase().includes('name'));
        const notesIndex = headers.findIndex(h => h && h.toLowerCase().includes('note'));
        
        // Process all messages
        rows.slice(1).forEach(row => {
          const name = nameIndex >= 0 ? (row[nameIndex] || '').trim() : '';
          let notes = notesIndex >= 0 ? (row[notesIndex] || '').trim() : '';
          
          if (name || notes) {
            // Extract user info
            let userName = 'Anonymous';
            let timestamp = new Date();
            
            const reportedMatch = notes.match(/ðŸ‘¤ Reported by:\s*(.+?) â€¢ â° (.+)$/);
            if (reportedMatch) {
              userName = reportedMatch[1].trim();
              notes = notes.replace(/ðŸ‘¤ Reported by:\s*.+? â€¢ â° .+$/, '').trim();
            }
            
            allMessages.push({
              name,
              notes,
              userName,
              timestamp,
              isCurrentUser: currentUser && userName === currentUser.name
            });
          }
        });
        
        // Sort by timestamp (oldest to newest for correct display)
        allMessages.sort((a, b) => a.timestamp - b.timestamp);
        
        // Display messages
        displayMessages();
        
      } catch (error) {
        console.error('Error loading chat:', error);
        listError.classList.remove('hidden');
        loadingState.classList.add('hidden');
      }
    }
    
    function displayMessages() {
      listBody.innerHTML = '';
      
      if (allMessages.length === 0) {
        showNoData();
        return;
      }
      
      // Update total reports count
      document.getElementById('total-reports').textContent = allMessages.length;
      document.getElementById('chat-subtitle').textContent = `${allMessages.length} community warnings`;
      
      // Display each message
      allMessages.forEach((msg, index) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.isCurrentUser ? 'sent slide-in-right' : 'slide-in-left'}`;
        messageDiv.style.animationDelay = `${index * 0.05}s`;
        
        // Generate avatar
        const initials = UserAccount.generateInitials(msg.userName);
        const hash = msg.userName.split('').reduce((a, b) => {
          a = ((a << 5) - a) + b.charCodeAt(0);
          return a & a;
        }, 0);
        
        const colors = [
          '#667eea', '#764ba2', '#f56565', '#ed8936', '#ecc94b',
          '#48bb78', '#38b2ac', '#4299e1', '#9f7aea', '#ed64a6'
        ];
        const color = colors[Math.abs(hash) % colors.length];
        
        // Time format
        const timeString = msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateString = msg.timestamp.toLocaleDateString([], { month: 'short', day: 'numeric' });
        
        messageDiv.innerHTML = `
          <div class="chat-avatar" style="background: ${color}">
            ${initials}
          </div>
          <div class="chat-bubble">
            <div class="chat-sender">
              <i class="fas fa-user"></i>
              ${msg.userName}
            </div>
            
            ${msg.name ? `
            <div class="blocked-info">
              <div class="blocked-label">
                <i class="fas fa-ban"></i>
                BLOCKED PERSON
              </div>
              <div class="blocked-name">${escapeHtml(msg.name)}</div>
              ${msg.notes ? `<div class="blocked-notes">${escapeHtml(msg.notes)}</div>` : ''}
            </div>
            ` : msg.notes ? `<div>${escapeHtml(msg.notes)}</div>` : ''}
            
            <div class="chat-time">
              <i class="far fa-clock"></i>
              ${timeString} â€¢ ${dateString}
            </div>
          </div>
        `;
        
        listBody.appendChild(messageDiv);
      });
      
      loadingState.classList.add('hidden');
      listBody.classList.remove('hidden');
      
      // Scroll to bottom to see latest messages
      setTimeout(() => {
        listBody.scrollTop = listBody.scrollHeight;
      }, 100);
    }
    
    function showNoData() {
      loadingState.classList.add('hidden');
      noData.classList.remove('hidden');
      listBody.classList.add('hidden');
    }
    
    // Helper functions
    function parseCSV(csvText) {
      const rows = [];
      let row = [];
      let cell = '';
      let inQuotes = false;
      
      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const next = csvText[i + 1];
        
        if (char === '"') {
          if (inQuotes && next === '"') {
            cell += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          row.push(cell);
          cell = '';
        } else if (char === '\n' && !inQuotes) {
          row.push(cell);
          rows.push(row);
          row = [];
          cell = '';
        } else if (char === '\r' && next === '\n' && !inQuotes) {
          row.push(cell);
          rows.push(row);
          row = [];
          cell = '';
          i++;
        } else {
          cell += char;
        }
      }
      
      if (cell || row.length) {
        row.push(cell);
        rows.push(row);
      }
      
      return rows;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', initApp);
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !listModal.classList.contains('hidden')) {
        listModal.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
